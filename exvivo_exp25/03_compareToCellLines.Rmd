---
title: "Compare sigs to Cell lines"
author: "Sara gosline"
date: "2025-02-28"
output: html_document
---

# Overlap

First we will evaluate the basic shared properties between the cell lines and the patient signatures - what is consistent?

## Get cell line data and patient signatures

We need to get the differential expression datasets and cell line data. 

```{r get data, message=FALSE, warning=FALSE}
library(tidyverse)
library(ggplot2)
library(MSnSet.utils)

source("synapseUtil.R")
syn = synapseLogin()

#for each signature, get complete feature and identify resistant and sensitive markers for each...


dcolors=c(none='#CCCAAA',Gilteritinib='#EEDD55',
          `Venetoclax`='#0072B2',
          `Decitabine`='#D14610',
          `Gilteritinib+Venetoclax`='#05820F',
          `Decitabine+Venetoclax`='#D172B2',
          `Gilteritinib+Decitabine`='#EDAE49',
          `Gilteritinib+Decitabine+Venetoclax`='#666666')




#pcolors=c(`507`='#667242',`335`="#997242",`292`="#227242",`035`="#887242")
pcolors=c(`035`='#669999',`292`="#AABB66",`335`="#BBAABB",`507`="#CCBB33")

druglist=list(UT='none',D='Decitabine',V='Venetoclax',G='Gilteritinib',
              GV='Gilteritinib+Venetoclax',GD='Gilteritinib+Decitabine',DV='Decitabine+Venetoclax',
              GVD='Gilteritinib+Decitabine+Venetoclax')

treatlist=druglist
names(treatlist)=paste(names(treatlist),'-UT',sep='')



sigs <- readr::read_tsv(syn$get('syn64943910')$path)|>
  mutate(marker=ifelse(logFC>0,'resistant','sensitive'))|>
  mutate(sig=adj.P.Val<0.05)|>
  subset(endsWith(contrast,'UT'))|>
  mutate(treatment=treatlist[contrast])



sigs|>subset(sig)|>
  group_by(marker,contrast)|>
  summarize(nMarkers=n())

#cell line
global<-read.table(syn$get('syn51197035')$path,fill=TRUE,header=T,row.names=NULL)|>
  subset(!is.na(value))|>
  subset(Exp!='Ex12')


```

## How do patient signatures look in cell lines?
```{r eval sigs}
#for each signature
sig_names<-unique(sigs$contrast)
cell_lines<-c('G','GV','GD','GVD')

## for a particular contrast and drug, we can measure how well those markers predict AUC
## this is a generalization of Camilo's ratio code..
calc_sig_in_celllines<-function(con, drug_sig,lfcthresh=0){
  
  sigcolors<-c(Ratio='#333333',`resistant signal`="#9999BB",`sensitive signal`='#AAAA77',none='#DDDDDD')
  ##take all the resistant indicators - features that are up-regulated upon drug treatment
  resistant_markers <- sigs %>% 
    filter(contrast == con)|>
    #subset(sig)|>
    arrange(t_test_pval) %>%
    subset(feature%in%global$Gene)|>
    subset(logFC>lfcthresh)|>
    slice(1:10)|>
        pull(feature)|>
    unique()
  
 ##take all the 'sensitive' indicators, drugs that are  down-regulated upon drug treatment
 sensitive_markers <- sigs %>% 
   filter(contrast == con)|>
   arrange(t_test_pval) %>%
   #subset(sig)|>
  subset(feature%in%global$Gene)|>
         subset(logFC<(-1*lfcthresh))|>
  slice(1:10)|>
     pull(feature)|>
    unique()
     
 sigs<-sigs|>
   mutate(sigMarker=ifelse(feature%in%sensitive_markers,'sensitive signal',
                           ifelse(feature%in%resistant_markers,'resistant signal','none')))
 ###let's plot the proteins
 lfcs<-sigs|>
   subset(contrast==con)|>
   arrange(logFC)#|>
 #  subset(sigMarker!='none')
 
# p<-ggplot(lfcs,aes(y=-1*log10(t_test_pval),x=logFC,col=sigMarker))+geom_point()+scale_color_manual(values=sigcolors)+theme_bw()+ggtitle(paste(treatlist[[con]],'Signature markers by p-value'))
# print(p)
 # print(paste('found',length(resistant_markers),'resistant and',length(sensitive_markers),'sensitive markers for',con))
  
  if(length(sensitive_markers)<2||length(resistant_markers)<2)
      return(data.frame(Rho=NULL,Rho.p=NULL,`Signature type`=NULL,t.pval=NULL,w.pval=NULL)
)

  ##find the drug data in the patient samples
  drug_vals<-subset(global,Treatment%in%c('none',drug_sig))|>
    dplyr::select(Sample,Gene,value)|>
    tidyr::pivot_wider(names_from=Sample,values_from=value,values_fill=0.0)|>
    tibble::column_to_rownames('Gene')
    
 # print(paste("Found",nrow(drug_vals),'auc vals for',drug_sig))
  ##heatmap of markers in sample?

  
  ##calculate the signature scores in patients amples
  sensitive_signal <- apply(drug_vals[sensitive_markers, ], 2, mean,na.rm=T)
  resistant_signal <- apply(drug_vals[resistant_markers, ], 2, mean,na.rm=T)
  signal <- resistant_signal - sensitive_signal
  
  #signal<-signal[drug_vals$sample_id]
  #print(signal)
  #signame=paste(con,'model signal')
  #aucval=paste(drug_sig,'AUC')
  
  mdata<-subset(global,Treatment%in%c('none',drug_sig))|>
    dplyr::select(Sample,State,Treatment)|>
    distinct()|>
    tibble::column_to_rownames('Sample')
    #mutate(auc=NA,signal=NA)|>
#    subset(Barcode.ID%in%drug_vals$sample_id)
  
  mdata[names(signal), 'Ratio'] <- signal
  mdata[names(resistant_signal), 'resistant signal'] <- resistant_signal
  mdata[names(sensitive_signal), 'sensitive signal'] <- sensitive_signal

 # mdata[drug_vals$sample_id, 'AUC'] <- drug_vals$auc
  
  
  ##create a sensitive/resistant group
  #mdata$group <- "NA"
  #mdata[mdata%>% filter(AUC < 100) %>% pull(Barcode.ID), "group"] <- "Sensitive"
  #mdata[mdata %>% filter(AUC >= 100,
 #                                     AUC < 200) %>% pull(Barcode.ID), "group"] <- "Middle"
  #mdata[mdata %>% filter(AUC >= 200) %>% pull(Barcode.ID), "group"] <- "Resistant"
  #mdata$group<-factor(mdata$group,levels=c("Sensitive","Middle",'Resistant'))
  
  
  cdata<-mdata#[,c('Ratio','AUC')]
  mdata<-mdata|>
    tidyr::pivot_longer(cols=c('Ratio','resistant signal','sensitive signal'),names_to='Signature type',values_to='signal')
  
  #valid<-rownames(cdata[is.na(cdata$AUC),])
  #print(valid)
  
  adata<-c(rep('sensitive signal',length(sensitive_markers)),rep('resistant signal',length(resistant_markers)))
  names(adata)=c(sensitive_markers,resistant_markers)
  #print(cdata)
  pheatmap::pheatmap(drug_vals[c(sensitive_markers,resistant_markers),],
                     annotation_col=cdata,cluster_rows=FALSE,clustering_distance_cols = 'correlation',
                     annotation_colors = list(signal=sigcolors),
                     annotation_row=data.frame(signal=adata),cellheight=10,main=paste(con,'signature in',drug_sig,'cell lines'))
           
  ## we can't do correlation here, instead do t-test
  ## to see if signature is different
 
  # corstats = mdata|>
  #     group_by(`Signature type`)|>
  #     summarize(Rho=cor(signal,AUC,use='complete.obs',method='spearman'),
  #                 Rho.p=cor.test(signal,AUC,use='complete.obs',method='spearman')$p.value)
  # 
  # ##compute sens vs. res p-values
  pvals=data.frame(`Signature type`=NULL,t.pval=NULL,w.pval=NULL)
  # 
  try(pvals<-mdata|>
         #subset(group%in%c('Sensitive','Resistant'))|>
         group_by(`Signature type`)|>
         summarize(t.pval=t.test(signal~Treatment)$p.value,w.pval=wilcox.test(signal~Treatment)$p.value))
  # 
  
  tp=pvals[1,'t.pval']
   p<-ggplot(mdata,aes(x=Treatment,y=signal,fill=`Signature type`))+
    geom_boxplot()+scale_fill_manual(values=sigcolors)+theme_bw()+ggtitle(paste(con,'signature in',drug_sig,'cell lines','\nt-test p=',tp))
  print(p)
  # corval=corstats[1,'Rho']
  # tp=pvals[1,'t.pval']
  # mdata<-subset(mdata,!is.na(AUC))
  # p1=ggplot(mdata,aes(x=AUC,y=signal,col=`Signature type`))+geom_point()+ggtitle(paste(con,'treated signature vs. AUC of ',drug_sig,'\n Rho =',corval))+scale_color_manual(values=sigcolors)+theme_bw()
  # p2=ggplot(mdata,aes(x=group,y=signal,fill=`Signature type`))+geom_boxplot()+ggtitle(paste(con,'treated signature vs. AUC of ',drug_sig,'\nt-test p=',tp))+scale_fill_manual(values=sigcolors)+theme_bw()
  # res=cowplot::plot_grid(p1,p2,nrow=2)
  # print(res) #eventually save
  # 
  # ret=merge(corstats,pvals)|>
  #   mutate(upProts=paste(resistant_markers,collapse=';'),downProts=paste(sensitive_markers,collapse=';'))
  # return(ret)
  return(pvals|>mutate(sig=con,cellLine=drug_sig))
}
 
pdf('cellLineHeatmaps.pdf')

res<-do.call(rbind,lapply(sig_names,function(sig) do.call(rbind,lapply(cell_lines,function(cel){calc_sig_in_celllines(sig,cel)}))))
dev.off()


```

## Get patient data - how do cell line signatures look in cell lines

# Network analysis
Then we will identify specific links between the cell line signatures and the patient signatures. Are their pathways? 


## What is all pairs shortest paths between pathways...


